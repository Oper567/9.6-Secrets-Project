<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Apugo | Village Square</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');

        body {
            background-color: #020617;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-nav {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-offline { background: #64748b; }

        ::-webkit-scrollbar { width: 0; }

        .post-card {
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .post-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .media-container {
            background: radial-gradient(circle, #0f172a, #020617);
        }
    </style>
</head>

<body class="min-h-screen pb-24">

<!-- NAV -->
<nav class="glass-nav sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">

        <div class="flex items-center gap-4">
            <button id="menu-btn" class="lg:hidden text-slate-400">
                <i class="fas fa-bars text-xl"></i>
            </button>

            <h1 onclick="location.href='/feed'"
                class="text-xl md:text-2xl font-black text-blue-500 italic tracking-tighter cursor-pointer">
                APUGO
            </h1>
        </div>

        <div class="flex items-center gap-5">
            <a href="/notifications" class="relative">
                <i class="far fa-bell text-xl text-slate-400"></i>

                <% if (unreadCount && unreadCount > 0) { %>
                    <span class="absolute -top-1 -right-1 bg-red-600 text-[8px] w-4 h-4 flex items-center justify-center rounded-full font-black">
                        <%= unreadCount %>
                    </span>
                <% } %>
            </a>

            <a href="/profile" class="w-9 h-9 rounded-full overflow-hidden border-2 border-slate-800">
                <% if (user.profile_pic) { %>
                    <img src="<%= user.profile_pic %>" class="w-full h-full object-cover">
                <% } else { %>
                    <div class="bg-slate-800 w-full h-full flex items-center justify-center font-bold text-blue-500">
                        <%= user.email[0] %>
                    </div>
                <% } %>
            </a>
        </div>
    </div>

    <div id="nav-dropdown" class="hidden px-4 pb-4">
        <form action="/feed" method="GET">
            <input
                type="text"
                name="search"
                placeholder="Search the square..."
                value="<%= search || '' %>"
                class="w-full bg-slate-950 border border-slate-800 rounded-2xl py-3 px-12 text-xs outline-none">
        </form>
    </div>
</nav>

<!-- MAIN -->
<main class="max-w-6xl mx-auto px-4 pt-6 grid grid-cols-1 lg:grid-cols-3 gap-8">

<!-- FEED -->
<section class="lg:col-span-2 space-y-8">

<!-- CREATE POST -->
<div class="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-6">
    <form action="/event/create" method="POST" enctype="multipart/form-data" id="postForm">

        <textarea
            name="description"
            required
            placeholder="Whisper a secret into the square..."
            class="w-full bg-transparent resize-none h-20 outline-none text-slate-200">
        </textarea>

        <div class="flex justify-between items-center mt-4">
            <label class="cursor-pointer text-xs bg-slate-800 px-4 py-2 rounded-xl">
                <input type="file" name="localMedia" class="hidden">
                <i class="fas fa-camera text-blue-500"></i> Media
            </label>

            <button type="submit"
                class="bg-blue-600 px-6 py-2 rounded-xl font-black text-xs uppercase">
                Publish
            </button>
        </div>
    </form>
</div>

<!-- POSTS -->
<% posts.forEach(p => { %>
<article class="post-card bg-slate-900 border border-slate-800 rounded-[2.5rem] overflow-hidden">

    <!-- HEADER -->
    <div class="p-5 flex justify-between">
        <div class="flex gap-3">
            <div class="relative">
                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center font-bold text-blue-500">
                    <%= p.author[0] %>
                </div>
                <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-slate-900
                    <%= p.is_online ? 'status-online' : 'status-offline' %>">
                </span>
            </div>

            <div>
                <p class="font-black">@<%= p.author.split('@')[0] %></p>
                <p class="text-[9px] text-slate-500">
                    <%= new Date(p.created_at).toLocaleDateString() %>
                </p>
            </div>
        </div>
    </div>

    <!-- CONTENT -->
    <div class="px-6 pb-4">
        <p class="text-slate-300"><%= p.description %></p>
    </div>

    <% if (p.image_url) { %>
    <div class="media-container">
        <img src="<%= p.image_url %>" class="w-full">
    </div>
    <% } %>

    <!-- ACTIONS -->
    <div class="p-6 text-xs uppercase font-black text-slate-500 flex gap-6">
        <span><%= p.likes_count || 0 %> Vibes</span>
        <span><%= p.comments_list ? p.comments_list.length : 0 %> Whispers</span>
    </div>

    <!-- COMMENTS (FIXED SECTION) -->
    <div class="px-6 pb-6 space-y-3">
        <% if (p.comments_list) { %>
            <% p.comments_list.slice(0, 2).forEach(c => { %>
                <div class="text-xs bg-slate-950 p-2 rounded-xl">
                    <span class="text-blue-500 font-black">
                        @<%= c.author.split('@')[0] %>:
                    </span>
                    <span class="text-slate-400">"<%= c.content %>"</span>
                </div>
            <% }) %>
        <% } %>
    </div>

</article>
<% }) %>

</section>

</main>

<script>
const menuBtn = document.getElementById('menu-btn');
const dropdown = document.getElementById('nav-dropdown');

menuBtn.onclick = () => dropdown.classList.toggle('hidden');
</script>

</body>
</html>
