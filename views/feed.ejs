<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apugo | Village Square</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background-color: #020617; }
    html, body { overflow-x: hidden; scroll-behavior: smooth; }

    .glass-nav { background: rgba(15,23,42,.9); backdrop-filter: blur(12px); }
    .status-online { background:#22c55e; box-shadow:0 0 8px #22c55e; }
    .status-offline { background:#64748b; }

    #toast-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
    }

    @keyframes slide {
      from { transform: translateX(-100%); opacity:0; }
      to { transform: translateX(0); opacity:1; }
    }

    .animate-notif { animation: slide .4s ease forwards; }

    .announcement-card {
      background: linear-gradient(to right, #1e293b, #0f172a);
      border-left: 4px solid #3b82f6;
    }
  </style>
</head>

<body class="text-slate-200 min-h-screen">

<div id="toast-container"></div>

<!-- NAV -->
<nav class="glass-nav border-b border-slate-800 p-4 sticky top-0 z-50">
  <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">

    <h1 onclick="location.href='/feed'"
        class="text-2xl font-black text-blue-500 italic tracking-tighter cursor-pointer">
      APUGO
    </h1>

    <form action="/feed" method="GET" class="relative w-full md:w-80">
      <input
        name="search"
        value="<%= search || '' %>"
        placeholder="Search the village..."
        class="w-full bg-slate-950 border border-slate-800 rounded-full py-1.5 px-10 text-sm outline-none focus:border-blue-600">
      <span class="absolute left-4 top-2 text-slate-500">üîç</span>
    </form>

    <div class="flex items-center gap-6">
      <div class="flex gap-4 text-[10px] font-black uppercase tracking-widest">
        <a href="/feed" class="text-blue-500">Feed</a>
        <a href="/discover" class="hover:text-blue-400">Discover</a>
        <a href="/messages" class="hover:text-blue-400">Messages</a>
        <a href="/profile" class="hover:text-white">Profile</a>
      </div>

      <div onclick="checkNotifs()" class="relative cursor-pointer">
        üîî
        <span id="notif-badge"
          class="absolute -top-1 -right-1 bg-red-600 text-[10px] px-1 rounded-full <%= unreadCount > 0 ? '' : 'hidden' %>">
          <%= unreadCount %>
        </span>
      </div>

      <a href="/logout" class="text-red-500 text-xs font-bold uppercase hover:underline">Logout</a>
    </div>
  </div>
</nav>

<!-- MAIN -->
<main class="max-w-6xl mx-auto px-4 pt-8 grid grid-cols-1 lg:grid-cols-3 gap-8 pb-10">

<!-- FEED -->
<section class="lg:col-span-2 space-y-6">

<!-- ANNOUNCEMENTS -->
<% if (announcements?.length) { %>
  <div class="space-y-3">
    <h2 class="text-[10px] font-black text-blue-500 uppercase tracking-[0.2em] ml-2">
      Village Proclamations
    </h2>

    <% announcements.forEach(a => { %>
      <div class="announcement-card p-4 rounded-2xl border border-slate-800">
        <div class="flex items-center gap-2 mb-2">
          <span class="bg-blue-600 text-[9px] px-2 py-0.5 rounded-full font-black uppercase">
            ELDERS
          </span>
          <p class="text-xs font-bold text-slate-400">
            @<%= a.author.split('@')[0] %>
          </p>
        </div>
        <p class="text-sm"><%= a.description %></p>
      </div>
    <% }) %>
  </div>
<% } %>

<!-- CREATE POST -->
<div class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
  <form id="postForm" action="/event/create" method="POST" enctype="multipart/form-data" class="space-y-4">
    <textarea name="description" required
      placeholder="What's happening in the village?"
      class="w-full bg-transparent outline-none h-20 resize-none text-lg placeholder-slate-600"></textarea>

    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 border-t border-slate-800 pt-4">
      <input type="file" name="localMedia"
        class="text-xs text-slate-500 file:mr-4 file:py-2 file:px-4
        file:rounded-full file:border-0 file:bg-slate-800 file:text-slate-300">

      <button id="postBtn"
        class="bg-blue-600 px-8 py-2.5 rounded-full font-black text-white flex gap-2">
        <span id="btnText">POST</span>
        <svg id="btnSpinner" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
        </svg>
      </button>
    </div>
  </form>
</div>

<!-- POSTS -->
<% posts.forEach(p => { 
  const diff = Math.floor((Date.now() - new Date(p.last_active)) / 1000);
%>

<article class="bg-slate-900 border border-slate-800 rounded-3xl p-6">
  <div class="flex justify-between mb-4">
    <div class="flex gap-3">
      <div class="relative">
        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-bold uppercase">
          <%= p.author[0] %>
        </div>
        <span class="absolute bottom-0 right-0 w-3 h-3 border-2 border-slate-900 rounded-full
          <%= diff < 300 ? 'status-online' : 'status-offline' %>"></span>
      </div>

      <div>
        <p class="font-bold text-sm">@<%= p.author.split('@')[0] %></p>
        <p class="text-[10px] text-slate-500 font-black uppercase">
          <% if (diff < 60) { %> Active now
          <% } else if (diff < 3600) { %> <%= Math.floor(diff/60) %>m ago
          <% } else { %> <%= Math.floor(diff/3600) %>h ago <% } %>
        </p>
      </div>
    </div>

    <% if (user && (user.id === p.created_by || user.role === 'admin')) { %>
      <button onclick="openDeleteModal('<%= p.id %>')" class="hover:text-red-500">üóëÔ∏è</button>
    <% } %>
  </div>

  <p class="mb-4 text-slate-300"><%= p.description %></p>

  <% if (p.image_url) { %>
    <div class="rounded-2xl overflow-hidden border border-slate-800 mb-4">
      <% if (p.media_type === 'video') { %>
        <video controls muted playsinline class="w-full max-h-[500px] bg-black">
          <source src="<%= p.image_url %>" type="video/mp4">
        </video>
      <% } else { %>
        <img src="<%= p.image_url %>" class="w-full" loading="lazy">
      <% } %>
    </div>
  <% } %>

  <div class="flex gap-6 pt-4 border-t border-slate-800 text-sm font-bold">
    <form action="/event/<%= p.id %>/like" method="POST">
      ‚ù§Ô∏è <%= p.likes_count || 0 %>
    </form>
    <span class="text-slate-500">üí¨ <%= p.comments_list?.length || 0 %></span>
  </div>
</article>

<% }) %>

</section>

<!-- SIDEBAR -->
<aside class="hidden lg:block">
  <div class="bg-slate-900 border border-slate-800 rounded-3xl p-6 sticky top-28">
    <h3 class="text-xs font-black text-blue-500 uppercase tracking-widest mb-4">
      Trending in Apugo
    </h3>

    <% trending.forEach(t => { %>
      <div class="border-b border-slate-800 pb-3 mb-3 last:border-0">
        <p class="text-sm font-bold truncate"><%= t.description %></p>
        <p class="text-[10px] text-blue-500 font-black uppercase">
          <%= t.likes_count %> LIKES
        </p>
      </div>
    <% }) %>
  </div>
</aside>

</main>

<!-- DELETE MODAL -->
<div id="deleteModal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div onclick="closeDeleteModal()" class="absolute inset-0 bg-black/70"></div>
  <div class="bg-slate-900 border border-slate-800 p-8 rounded-3xl z-10 w-full max-w-sm">
    <h3 class="text-xl font-black mb-2">Delete Post?</h3>
    <p class="text-slate-400 mb-6 text-sm">This cannot be undone.</p>
    <form id="confirmDeleteForm" method="POST" class="space-y-3">
      <button class="w-full bg-red-600 py-3 rounded-full font-black">DELETE</button>
      <button type="button" onclick="closeDeleteModal()"
        class="w-full bg-slate-800 py-3 rounded-full font-black">
        CANCEL
      </button>
    </form>
  </div>
</div>

<script>
/* Notifications */
async function checkNotifs() {
  try {
    const res = await fetch('/api/notifications');
    if (!res.ok) return;
    const data = await res.json();
    const container = document.getElementById('toast-container');

    data.forEach(n => {
      const toast = document.createElement('div');
      toast.className = 'bg-blue-600 p-4 rounded-2xl mb-2 animate-notif font-bold';
      toast.textContent = n.message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4500);
    });
  } catch {}
}
setInterval(checkNotifs, 15000);

/* Post submit */
document.getElementById('postForm').addEventListener('submit', () => {
  postBtn.disabled = true;
  btnText.textContent = 'UPLOADING...';
  btnSpinner.classList.remove('hidden');
});

/* Delete modal */
function openDeleteModal(id) {
  confirmDeleteForm.action = `/event/${id}/delete`;
  deleteModal.classList.remove('hidden');
  deleteModal.classList.add('flex');
}
function closeDeleteModal() {
  deleteModal.classList.add('hidden');
  deleteModal.classList.remove('flex');
}
</script>

</body>
</html>
