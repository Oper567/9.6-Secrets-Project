<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>Apugo | Village Square</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            background: radial-gradient(circle at top right, #0f172a, #020617); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent;
        }
        .glass-nav {
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .post-card {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .letter-avatar {
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 800; text-transform: uppercase;
            user-select: none; flex-shrink: 0;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .comment-section {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .comment-section.open { max-height: 1000px; }

        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }
        .skeleton {
            background: linear-gradient(to right, rgba(255,255,255,0.05) 8%, rgba(255,255,255,0.1) 18%, rgba(255,255,255,0.05) 33%);
            background-size: 800px 104px;
            animation: shimmer 1.5s linear infinite forwards;
        }
    </style>
</head>
<body class="min-h-screen pb-24">

    <nav class="glass-nav sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <h1 class="text-xl font-black text-blue-500 italic tracking-tighter cursor-pointer" onclick="window.location.reload()">APUGO</h1>
            
            <div class="hidden md:flex flex-1 max-w-sm mx-8 relative">
                <form action="/feed" method="GET" class="w-full">
                    <input type="text" name="search" placeholder="Search the square..." value="<%= search %>" 
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-2 px-10 text-xs text-white outline-none focus:border-blue-500/50">
                    <i class="fas fa-search absolute left-4 top-2.5 text-slate-600 text-[10px]"></i>
                </form>
            </div>

            <div class="flex items-center gap-4">
                <a href="/notifications" class="relative p-2 text-slate-400">
                    <i class="far fa-bell text-xl"></i>
                    <% if (unreadCount > 0) { %><span class="absolute top-1 right-1 bg-blue-600 w-2 h-2 rounded-full"></span><% } %>
                </a>
                <div class="w-9 h-9 rounded-full letter-avatar border border-white/10" data-label="<%= user.email %>">
                    <%= user.email.charAt(0) %>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-3 mt-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-8">
            
            <section class="lg:hidden mb-8">
                <h3 class="text-[9px] font-black text-blue-500 uppercase tracking-[0.3em] mb-4">Trending Whispers</h3>
                <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                    <% trending.forEach((t, i) => { %>
                        <div class="flex-shrink-0 w-44 bg-white/5 rounded-2xl p-4 border border-white/5 post-card">
                            <span class="text-[10px] font-black text-white/20">#<%= i+1 %></span>
                            <p class="text-[11px] text-slate-300 font-bold line-clamp-1 my-1"><%= t.content %></p>
                            <span class="text-[8px] font-black text-blue-500 uppercase"><%= t.views_count %> Views</span>
                        </div>
                    <% }) %>
                </div>
            </section>

            <section class="post-card rounded-[2rem] p-5 mb-8">
                <form id="uploadForm">
                    <div class="flex gap-4">
                        <div class="w-12 h-12 rounded-2xl letter-avatar" data-label="<%= user.email %>"><%= user.email.charAt(0) %></div>
                        <textarea id="description" name="description" placeholder="Whisper something to the village..." 
                            class="flex-1 bg-transparent outline-none h-20 resize-none text-slate-200 mt-2 placeholder-slate-600"></textarea>
                    </div>

                    <div id="mediaPreviewContainer" class="hidden mt-4 relative rounded-2xl overflow-hidden border border-white/5 bg-black/40">
                        <div id="previewContent"></div>
                        <button type="button" onclick="clearMedia()" class="absolute top-2 right-2 bg-black/60 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
                    </div>

                    <div id="uploadProgressContainer" class="hidden w-full bg-white/5 rounded-full h-1.5 mt-4 overflow-hidden">
                        <div id="uploadProgressBar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
                    </div>

                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-white/5">
                        <input type="file" name="localMedia" id="fileInput" class="hidden" accept="image/*,video/*">
                        <label for="fileInput" class="cursor-pointer text-slate-400 text-[10px] font-black uppercase tracking-widest flex items-center gap-2 hover:text-blue-400">
                            <i class="fas fa-photo-video text-lg"></i> Media
                        </label>
                        <button type="button" id="publishBtn" onclick="uploadPost()" class="bg-blue-600 px-8 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest text-white shadow-lg">
                            Publish
                        </button>
                    </div>
                </form>
            </section>

            <div id="skeleton-loader" class="space-y-6">
                <div class="post-card rounded-[2rem] p-6 space-y-4"><div class="w-full h-48 skeleton rounded-2xl"></div></div>
            </div>

            <div id="feed-content" class="hidden space-y-6">
                <% if (posts.length > 0) { %>
                    <% posts.forEach(p => { %>
                        <article class="post-card rounded-[2.5rem] overflow-hidden">
                            <div class="p-6 flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl letter-avatar" data-label="<%= p.author_email %>"><%= p.author_email.charAt(0) %></div>
                                <div>
                                    <p class="font-bold text-sm">@<%= p.author_email.split('@')[0] %></p>
                                    <p class="text-[9px] text-slate-600 uppercase font-black tracking-tighter"><%= new Date(p.created_at).toDateString() %></p>
                                </div>
                            </div>

                            <div class="px-8 pb-4 text-slate-300 text-[15px] leading-relaxed"><%= p.content %></div>

                            <% if (p.image_url) { %>
                                <div class="px-4 pb-4">
                                    <% if (p.media_type === 'video') { %>
                                        <div class="px-2 mb-2 flex items-center gap-2">
                                            <i class="fas fa-eye text-blue-500 text-[10px]"></i>
                                            <span class="text-[9px] font-black text-slate-500 uppercase"><%= p.views_count || 0 %> Views</span>
                                        </div>
                                        <div class="relative rounded-[1.8rem] overflow-hidden group border border-white/5">
                                            <video controls playsinline class="w-full village-video shadow-2xl" data-post-id="<%= p.id %>">
                                                <source src="<%= p.image_url %>">
                                            </video>
                                            <a href="<%= p.image_url %>" download="Apugo_Video_<%= p.id %>.mp4" class="absolute top-4 right-4 bg-black/60 p-3 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-download"></i></a>
                                        </div>
                                    <% } else { %>
                                        <div class="relative rounded-[1.8rem] overflow-hidden group border border-white/5">
                                            <img src="<%= p.image_url %>" class="w-full h-auto" loading="lazy">
                                            <a href="<%= p.image_url %>" download class="absolute top-4 right-4 bg-black/60 p-3 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-download"></i></a>
                                        </div>
                                    <% } %>
                                </div>
                            <% } %>

                            <div class="px-8 py-5 border-t border-white/5 flex gap-8">
                                <button onclick="sendVibe(this, '<%= p.id %>')" class="flex items-center gap-2 text-[10px] font-black <%= p.liked_by_me ? 'text-red-500' : 'text-slate-500' %>">
                                    <i class="<%= p.liked_by_me ? 'fas' : 'far' %> fa-heart text-lg"></i>
                                    <span><%= p.likes_count || 0 %></span>
                                </button>
                                <button onclick="toggleEchoes('<%= p.id %>')" class="text-slate-500 text-[10px] font-black uppercase flex items-center gap-2">
                                    <i class="far fa-comment text-lg"></i> Echoes
                                </button>
                                <button onclick="sharePost('<%= p.id %>', '<%= p.content.substring(0,50) %>')" class="text-slate-500 text-[10px] font-black uppercase flex items-center gap-2">
                                    <i class="fas fa-share-nodes text-lg"></i> Share
                                </button>
                            </div>

                            <div id="echoes-<%= p.id %>" class="comment-section bg-black/20">
                                <div class="p-4 space-y-3 max-h-60 overflow-y-auto no-scrollbar">
                                    <% if (p.comments_list) { %>
                                        <% p.comments_list.forEach(c => { %>
                                            <div class="flex gap-2 text-[12px]">
                                                <span class="text-blue-500 font-bold">@<%= c.username %></span>
                                                <span class="text-slate-400"><%= c.comment_text %></span>
                                            </div>
                                        <% }) %>
                                    <% } %>
                                </div>
                                <form onsubmit="postEcho(event, '<%= p.id %>')" class="p-4 flex gap-2 border-t border-white/5">
                                    <input name="comment" required placeholder="Add an echo..." class="flex-1 bg-slate-900 border border-white/10 rounded-xl px-4 py-2 text-xs text-white outline-none">
                                    <button type="submit" class="bg-blue-600 w-10 h-10 rounded-xl text-white"><i class="fas fa-paper-plane text-xs"></i></button>
                                </form>
                            </div>
                        </article>
                    <% }) %>
                <% } else { %>
                    <div class="text-center py-20 opacity-20 font-black uppercase tracking-widest text-[10px]">The Square is quiet...</div>
                <% } %>
            </div>
        </div>

        <aside class="hidden lg:block lg:col-span-4">
            <div class="sticky top-24 space-y-6">
                <div class="post-card rounded-[2rem] p-6 border-blue-500/10 border">
                    <h3 class="text-[10px] font-black text-blue-500 uppercase tracking-[0.3em] mb-6">Trending Whispers</h3>
                    <div class="space-y-6">
                        <% trending.forEach((t, i) => { %>
                            <div class="flex gap-4 items-start group cursor-pointer" onclick="window.location.href='/post/<%= t.id %>'">
                                <span class="text-2xl font-black text-white/5 italic">0<%= i+1 %></span>
                                <div>
                                    <p class="text-xs font-bold text-slate-300 group-hover:text-blue-400 transition-colors line-clamp-2"><%= t.content %></p>
                                    <div class="flex items-center gap-2 mt-1">
                                        <i class="fas fa-play text-[8px] text-slate-600"></i>
                                        <span class="text-[9px] font-black text-slate-600 uppercase tracking-tighter"><%= t.views_count %> Views</span>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <script>
        // --- AVATARS ---
        function applyAvatarColors() {
            document.querySelectorAll('.letter-avatar').forEach(avatar => {
                let str = avatar.getAttribute('data-label') || 'user';
                let hash = 0;
                for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
                avatar.style.background = `hsl(${hash % 360}, 60%, 45%)`;
            });
        }

        // --- SKELETON TIMEOUT ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('skeleton-loader').style.display = 'none';
                document.getElementById('feed-content').classList.remove('hidden');
                applyAvatarColors();
                initVideoTracking();
            }, 500);
        });

        // --- MEDIA PREVIEW ---
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const content = document.getElementById('previewContent');
                content.innerHTML = file.type.startsWith('video/') 
                    ? `<video src="${e.target.result}" class="w-full aspect-video object-cover rounded-2xl" muted autoplay loop></video>`
                    : `<img src="${e.target.result}" class="w-full h-auto rounded-2xl">`;
                document.getElementById('mediaPreviewContainer').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        function clearMedia() {
            fileInput.value = "";
            document.getElementById('mediaPreviewContainer').classList.add('hidden');
        }

        // --- VIDEO TRACKING ---
        function initVideoTracking() {
            document.querySelectorAll('.village-video').forEach(video => {
                video.addEventListener('play', function() {
                    fetch(`/event/${this.getAttribute('data-post-id')}/view`, { method: 'POST' });
                }, { once: true });
            });
        }

        // --- NATIVE SHARING ---
        async function sharePost(id, text) {
            const data = { title: 'Apugo', text: text, url: window.location.origin + '/post/' + id };
            try {
                if (navigator.share) await navigator.share(data);
                else {
                    navigator.clipboard.writeText(data.url);
                    alert("Link copied!");
                }
            } catch (err) {}
        }

        // --- AJAX POST ---
        async function uploadPost() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            const btn = document.getElementById('publishBtn');
            const bar = document.getElementById('uploadProgressBar');
            const container = document.getElementById('uploadProgressContainer');

            if(!document.getElementById('description').value.trim() && !fileInput.files[0]) return;

            btn.disabled = true;
            btn.innerText = "SENDING...";
            container.classList.remove('hidden');

            const xhr = new XMLHttpRequest();
            xhr.upload.addEventListener("progress", (e) => {
                if(e.lengthComputable) bar.style.width = Math.round((e.loaded / e.total) * 100) + "%";
            });

            xhr.onload = () => {
                if(xhr.status === 200) window.location.reload();
                else { alert("Error!"); btn.disabled = false; btn.innerText="Publish"; }
            };

            xhr.open("POST", "/event/create");
            xhr.send(formData);
        }

        function toggleEchoes(id) { document.getElementById(`echoes-${id}`).classList.toggle('open'); }

        async function sendVibe(btn, id) {
            const res = await fetch(`/event/${id}/like`, { method: 'POST' });
            const data = await res.json();
            if(data.success) {
                btn.querySelector('span').innerText = data.newCount;
                btn.classList.toggle('text-red-500', data.isLiked);
                btn.classList.toggle('text-slate-500', !data.isLiked);
                btn.querySelector('i').className = data.isLiked ? 'fas fa-heart text-lg' : 'far fa-heart text-lg';
            }
        }
        async function postEcho(event, postId) {
    event.preventDefault();
    const form = event.target;
    const input = form.querySelector('input[name="comment"]');
    const commentText = input.value;
    const container = document.querySelector(`#echoes-${postId} .p-4`);

    try {
        const response = await fetch(`/event/${postId}/echo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ comment: commentText })
        });

        const data = await response.json();

        if (data.success) {
            // Create the new comment element
            const echoDiv = document.createElement('div');
            echoDiv.className = 'flex gap-2 text-[12px] animate-pulse';
            echoDiv.innerHTML = `
                <span class="text-blue-500 font-bold">@${data.username}</span>
                <span class="text-slate-400">${data.text}</span>
            `;
            
            // Add to list and clear input
            container.appendChild(echoDiv);
            input.value = "";
            echoDiv.classList.remove('animate-pulse');
            
            // Scroll to bottom of comments
            container.scrollTop = container.scrollHeight;
        }
    } catch (err) {
        alert("The village echo didn't travel... try again.");
    }
}
    </script>
</body>
</html>